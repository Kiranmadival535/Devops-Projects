trigger:
  branches:
    include:
      - master
  paths:
    include:
      - app/*
      - azure_devops_project/*
      - azure-pipelines-build.yml

parameters:
  - name: environment
    displayName: "Select Environment to Deploy"
    type: string
    default: 'dev'
    values:
      - dev
      - stage
      - all
stages:
# ======================
# 1️⃣ Build & Push Docker Image
# ======================
- stage: Build
  displayName: "Build and Push Docker Image"
  jobs:
  - job: build
    pool:
      name: 'SelfHosted'
    steps:
      - checkout: self
        clean: true
        fetchDepth: 0

      - task: Docker@2
        displayName: "Build and Push to Docker Hub"
        inputs:
          containerRegistry: 'Dockerserviceconnection'
          repository: 'madival/azureproject'
          command: 'buildAndPush'
          Dockerfile: '$(System.DefaultWorkingDirectory)/app/Dockerfile'
          tags: |
            latest
            $(Build.BuildId)

# =========================
# 2️⃣ Validate Stage — Terraform Validation
# =========================
- stage: Validate
  displayName: "Validate Terraform Configuration"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: Terraform_Validate
    pool:
      name: 'SelfHosted'
    steps:
      - checkout: self

      - task: TerraformInstaller@1
        inputs:
          terraformVersion: 'latest'

      - task: TerraformTask@5
        displayName: "Terraform Init (Dev)"
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
          backendAzureRmUseEntraIdForAuthentication: false
          backendServiceArm: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'
          backendAzureRmResourceGroupName: 'terraform-state-rg'
          backendAzureRmStorageAccountName: 'tfdevbackenddevops123'
          backendAzureRmContainerName: 'tfstate'
          backendAzureRmKey: 'dev.terraform.tfstate'

      - task: TerraformTask@5
        displayName: "Terraform Validate"
        inputs:
          provider: 'azurerm'
          command: 'validate'
          workingDirectory: '$(System.DefaultWorkingDirectory)/dev'

# =========================
# 3️⃣ Dev Deployment — Infra + AKS Deploy
# =========================
- stage: Dev_Deploy
  displayName: "Deploy to Dev Environment"
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - job: Terraform_Apply_Dev
    displayName: "Terraform Apply (Dev)"
    pool:
      name: 'SelfHosted'
    steps:
      - checkout: self

      - task: TerraformInstaller@1
        inputs:
          terraformVersion: 'latest'

      - task: TerraformTask@5
        displayName: "Terraform Init (Dev)"
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
          backendAzureRmUseEntraIdForAuthentication: false
          backendServiceArm: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'
          backendAzureRmResourceGroupName: 'terraform-state-rg'
          backendAzureRmStorageAccountName: 'tfdevbackenddevops123'
          backendAzureRmContainerName: 'tfstate'
          backendAzureRmKey: 'dev.terraform.tfstate'

      - task: TerraformTask@5
        displayName: "Terraform Apply (Dev)"
        inputs:
          provider: 'azurerm'
          command: 'apply'
          workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
          commandOptions: '--auto-approve'
          environmentServiceNameAzureRM: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'

  - job: Deploy_AKS_Dev
    displayName: "Deploy Application to AKS (Dev)"
    dependsOn: Terraform_Apply_Dev
    pool:
      name: 'SelfHosted'
    steps:
      - checkout: self

      - task: FileTransform@2
        displayName: "Replace $(env) in K8s manifests"
        inputs:
          folderPath: '$(System.DefaultWorkingDirectory)/k8s'
          fileType: 'yaml'
          targetFiles: '**/*.yml'

      # ✅ Working AKS deployment section
      - task: KubernetesManifest@1
        inputs:
          action: 'deploy'
          connectionType: 'azureResourceManager'
          azureSubscriptionConnection: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'
          azureResourceGroup: 'dev-rg'
          kubernetesCluster: 'dev-cluster'
          manifests: '$(System.DefaultWorkingDirectory)/k8s/*.yml'

      - task: AzureCLI@2
        displayName: "Get AKS Credentials (Dev)"
        inputs:
          azureSubscription: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'
          scriptType: 'powershell'
          scriptLocation: 'inlineScript'
          inlineScript: |
            Write-Host "Fetching AKS credentials..."
            az aks get-credentials --resource-group dev-rg --name dev-cluster --overwrite-existing
            Write-Host "Testing AKS connection..."
            kubectl get nodes

      - script: |
          kubectl get pods -o wide
          kubectl get svc
        displayName: "Verify Deployment"

# =========================
# 4️⃣ Stage Deployment — Infra + AKS (runs only if Dev succeeds)
# =========================
- stage: Stage_Deploy
  displayName: "Deploy to Stage Environment"
  dependsOn: Dev_Deploy
  condition: succeeded()
  jobs:
  - job: Terraform_Apply_Stage
    displayName: "Terraform Apply (Stage)"
    pool:
      name: 'SelfHosted'
    steps:
      - checkout: self

      - task: TerraformInstaller@1
        inputs:
          terraformVersion: 'latest'

      - task: TerraformTask@5
        displayName: "Terraform Init (Stage)"
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/staging'
          backendAzureRmUseEntraIdForAuthentication: false
          backendServiceArm: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'
          backendAzureRmResourceGroupName: 'terraform-state-rg'
          backendAzureRmStorageAccountName: 'tfstagebackenddevops123'
          backendAzureRmContainerName: 'tfstate'
          backendAzureRmKey: 'stage.terraform.tfstate'

      - task: TerraformTask@5
        displayName: "Terraform Apply (Stage)"
        inputs:
          provider: 'azurerm'
          command: 'apply'
          workingDirectory: '$(System.DefaultWorkingDirectory)/staging'
          commandOptions: '--auto-approve'
          environmentServiceNameAzureRM: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'

  - job: Deploy_AKS_Stage
    displayName: "Deploy Application to AKS (Stage)"
    dependsOn: Terraform_Apply_Stage
    pool:
      name: 'SelfHosted'
    steps:
      - checkout: self

      - task: FileTransform@2
        displayName: "Replace $(env) in K8s manifests"
        inputs:
          folderPath: '$(System.DefaultWorkingDirectory)/k8s'
          fileType: 'yaml'
          targetFiles: '**/*.yml'

      # ✅ Working AKS deployment section for Stage
      - task: KubernetesManifest@1
        inputs:
          action: 'deploy'
          connectionType: 'azureResourceManager'
          azureSubscriptionConnection: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'
          azureResourceGroup: 'stage-rg'
          kubernetesCluster: 'stage-cluster'
          manifests: '$(System.DefaultWorkingDirectory)/k8s/*.yml'

      - task: AzureCLI@2
        displayName: "Get AKS Credentials (Stage)"
        inputs:
          azureSubscription: 'Azure subscription 1(7e1882db-f3bd-43ad-8e09-9aadc9c0e01a)'
          scriptType: 'powershell'
          scriptLocation: 'inlineScript'
          inlineScript: |
            Write-Host "Fetching AKS credentials..."
            az aks get-credentials --resource-group stage-rg --name stage-cluster --overwrite-existing
            Write-Host "Testing AKS connection..."
            kubectl get nodes

      - script: |
          kubectl get pods -o wide
          kubectl get svc
        displayName: "Verify Deployment"
